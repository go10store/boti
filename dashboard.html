<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚ - Ø¨ÙˆØ·ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Mobile-First Dashboard Overrides */
        .dashboard-grid {
            display: grid;
            gap: 1rem;
        }

        .status-btn {
            padding: 1rem;
            border-radius: 12px;
            border: 2px solid transparent;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            /* Centering content */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            height: 100px;
            /* Fixed height for squares */
        }

        .status-btn.active {
            border-color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            transform: scale(1.02);
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .input-group-dark {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="container nav-content">
            <div class="logo">
                <span style="color:var(--text-main)">Ù„ÙˆØ­Ø©</span> Ø§Ù„Ø³Ø§Ø¦Ù‚
            </div>
            <a href="#" onclick="logout()" class="btn btn-secondary"
                style="padding: 0.5rem 1rem; font-size: 0.8rem;">Ø®Ø±ÙˆØ¬</a>
        </div>
    </header>

    <main class="container" style="max-width: 500px; margin-top: 5rem;">

        <!-- Login Section -->
        <div id="login-section" class="card fade-in">
            <h2 style="text-align: center; margin-bottom: 1.5rem; color: var(--accent);">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" name="phone" class="form-control" required placeholder="091 xxx">
                </div>
                <div class="form-group">
                    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <div class="input-wrapper">
                        <input type="password" id="passwordInput" name="password" class="form-control" required
                            placeholder="****">
                        <button type="button" class="input-icon-btn" onclick="togglePin('passwordInput')">ğŸ‘ï¸</button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top: 1rem;">Ø¯Ø®ÙˆÙ„</button>

                <div
                    style="text-align: center; margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1rem;">
                    <p style="color: var(--text-sub); margin-bottom: 0.5rem; font-size: 0.9rem;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</p>
                    <a href="register.html" class="btn btn-secondary"
                        style="width:100%; display:block; text-align:center;">ğŸš› Ø³Ø¬Ù„ Ø´Ø§Ø­Ù†ØªÙƒ Ø§Ù„Ø¢Ù†</a>
                </div>
            </form>
        </div>

        <script>
            function togglePin(id) {
                const input = document.getElementById(id);
                input.type = input.type === 'password' ? 'text' : 'password';
            }
        </script>

        <!-- Dashboard Section -->
        <div id="dashboard-section" style="display: none;">

            <!-- Welcome Card -->
            <div class="control-panel slide-up" style="margin-bottom: 1.5rem;">
                <h2 id="driverName" style="color: var(--accent); margin-bottom: 0.5rem;">Ù…Ø±Ø­Ø¨Ø§Ù‹</h2>
                <p style="color: var(--text-sub); font-size: 0.9rem;">Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„ØªÙƒ ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§ØªÙƒ</p>
            </div>

            <!-- Status Control -->
            <h3 style="color: var(--text-main); margin-bottom: 1rem;">Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„</h3>
            <div class="dashboard-grid slide-up" style="grid-template-columns: 1fr 1fr; margin-bottom: 2rem;">
                <button onclick="changeStatus('AVAILABLE')" id="btn-AVAILABLE" class="status-btn"
                    style="background: rgba(16, 185, 129, 0.2); color: #10B981;">
                    <span style="font-size: 1.5rem;">ğŸŸ¢</span>
                    Ù…ØªØ§Ø­
                </button>
                <button onclick="changeStatus('BUSY')" id="btn-BUSY" class="status-btn"
                    style="background: rgba(239, 68, 68, 0.2); color: #EF4444;">
                    <span style="font-size: 1.5rem;">ğŸ”´</span>
                    Ù…Ø´ØºÙˆÙ„
                </button>
                <button onclick="changeStatus('EN_ROUTE')" id="btn-EN_ROUTE" class="status-btn"
                    style="background: rgba(245, 158, 11, 0.2); color: #F59E0B;">
                    <span style="font-size: 1.5rem;">ğŸŸ¡</span>
                    ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚
                </button>
                <button onclick="changeStatus('OFF_DUTY')" id="btn-OFF_DUTY" class="status-btn"
                    style="background: rgba(107, 114, 128, 0.2); color: #9CA3AF;">
                    <span style="font-size: 1.5rem;">ğŸ’¤</span>
                    Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©
                </button>
            </div>

            <!-- Settings -->
            <h3 style="color: var(--text-main); margin-bottom: 1rem;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <div class="control-panel slide-up" style="animation-delay: 0.1s;">

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="color: var(--text-sub); font-size: 0.9rem;">Ø§Ù„Ø³Ø¹Ø± (Ø¯.Ù„)</label>
                    <input type="number" id="editPrice" class="form-control" style="background: rgba(0,0,0,0.3);">
                </div>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label style="color: var(--text-sub); font-size: 0.9rem;">Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„</label>
                    <select id="editWorkHours" class="form-control" style="background: rgba(0,0,0,0.3);">
                        <option value="ALWAYS">Ù…ØªØ§Ø­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ (24/7)</option>
                        <option value="MORNING">Ø§Ù„ÙØªØ±Ø© Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ© ÙÙ‚Ø·</option>
                        <option value="EVENING">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø³Ø§Ø¦ÙŠØ© ÙÙ‚Ø·</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="color: var(--text-sub); font-size: 0.9rem;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                    <input type="tel" id="editPhone" class="form-control" style="background: rgba(0,0,0,0.3);">
                </div>

                <button onclick="saveProfile()" class="btn btn-primary" style="width: 100%;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>

            <!-- Danger Zone -->
            <div class="control-panel slide-up"
                style="margin-top: 1.5rem; border-color: rgba(239, 68, 68, 0.3); animation-delay: 0.2s;">
                <button onclick="deleteAccount()" class="btn"
                    style="width:100%; background: transparent; color: var(--error); border: 1px solid var(--error);">
                    ğŸ—‘ï¸ Ø·Ù„Ø¨ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
                </button>
            </div>

        </div>

    </main>

    <script src="app.js"></script>
    <script>
        let currentDriver = null;

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const phone = e.target.phone.value;
            const password = e.target.password.value;

            currentDriver = await loginDriver(phone, password);

            if (currentDriver) {
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!', 'success');
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('driverName').innerText = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentDriver.name.split(' ')[0]}`;
                document.getElementById('editPhone').value = currentDriver.phone;
                updateStatusUI(currentDriver.workStatus || 'AVAILABLE');
            } else {
                showNotification('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
            }
        });

        async function changeStatus(status) {
            if (!currentDriver) return;
            // Optimistic UI update
            updateStatusUI(status);

            const success = await updateDriverStatus(currentDriver.id, status);
            if (success) {
                currentDriver.workStatus = status;
                showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©', 'success');
            } else {
                showNotification('ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'error');
                // Revert if failed (optional, simplifed for now)
            }
        }

        function updateStatusUI(status) {
            // Reset all buttons
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.opacity = '0.7';
            });

            // Activate current
            const activeBtn = document.getElementById(`btn-${status}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                activeBtn.style.opacity = '1';
            }
        }

        async function saveProfile() {
            if (!currentDriver) return;
            const newPhone = document.getElementById('editPhone').value;
            const newPrice = document.getElementById('editPrice').value;
            const newHours = document.getElementById('editWorkHours').value;

            if (!newPhone.startsWith('09') || newPhone.length !== 10) {
                showNotification('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/driver/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: currentDriver.id,
                        phone: newPhone,
                        price: newPrice,
                        workHours: newHours
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    currentDriver.phone = newPhone;
                    currentDriver.price = newPrice;
                    currentDriver.workHours = newHours;
                } else {
                    showNotification('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸', 'error');
                }
            } catch (e) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„', 'error');
            }
        }

        function logout() {
            currentDriver = null;
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('loginForm').reset();
            showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', 'info');
        }

        async function deleteAccount() {
            if (!currentDriver) return;
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ù„Ø¨ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ÙƒØŸ')) return;

            const result = await requestAccountDeletion(currentDriver.id);
            if (result.success) {
                showNotification(result.message, 'success');
                setTimeout(logout, 2000);
            } else {
                showNotification(result.message || 'ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨', 'error');
            }
        }
    </script>
</body>

</html>
