<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø¨ÙˆØ·ÙŠ</title>
    <link rel="stylesheet" href="style.css">
</head>

<body style="background: #011627;">
    <header class="site-header">
        <div class="container nav-content">
            <div class="logo">
                <span style="color:var(--text-main)">Ø¥Ø¯Ø§Ø±Ø©</span> Ø¨ÙˆØ·ÙŠ
            </div>
            <a href="index.html" class="btn btn-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    style="margin-left:8px">
                    <line x1="19" y1="12" x2="5" y2="12"></line>
                    <polyline points="12 19 5 12 12 5"></polyline>
                </svg>
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            </a>
        </div>
    </header>

    <div class="container" style="max-width:1200px; margin-top:3rem;">

        <!-- Login -->
        <div id="admin-login" class="card">
            <h2 style="text-align: center; color: var(--accent); margin-bottom: 1.5rem;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <input type="password" id="adminPass" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"
                style="margin:1rem 0;">
            <button onclick="adminLogin()" class="btn btn-primary" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <!-- Dashboard -->
        <div id="admin-dash" style="display:none;">
            <!-- Tabs -->
            <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
                <button onclick="showTab('drivers')" class="btn btn-secondary" id="drivers-tab">Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</button>
                <button onclick="showTab('orders')" class="btn btn-secondary" id="orders-tab" style="position: relative;">
                    Ø§Ù„Ø·Ù„Ø¨Ø§Øª 
                    <span id="order-notification" style="position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; align-items: center; justify-content: center; font-size: 0.7rem;">0</span>
                </button>
            </div>

            <!-- Drivers Tab -->
            <div id="drivers-tab-content">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h1 style="color:var(--accent);">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h1>
                    <button onclick="loadRequests()" class="btn btn-secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                </div>

                <div id="requests-list" class="grid" style="grid-template-columns: 1fr;">
                    <!-- Items here -->
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders-tab-content" style="display: none;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h1 style="color:var(--accent);">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h1>
                    <button onclick="loadOrders()" class="btn btn-secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                </div>

                <div id="orders-list" class="grid" style="grid-template-columns: 1fr;">
                    <!-- Orders will be loaded here -->
                </div>
            </div>
        </div>

    </div>

    <footer>
        <p>Â© 2025 ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙˆØ·ÙŠ</p>
        <p class="alkow">ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Alkow Software</p>
    </footer>

    <script>
        const API_URL = '/api'; // Relative in production
        let pendingOrdersCount = 0;
        let ordersPollingInterval = null;

        async function adminLogin() {
            const pwd = document.getElementById('adminPass').value;
            const res = await fetch(`${API_URL}/admin/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pwd })
            });
            const data = await res.json();

            if (data.success) {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-dash').style.display = 'block';
                loadRequests();
                loadOrders();
                // Start polling for new orders
                startOrdersPolling();
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©');
            }
        }

        function startOrdersPolling() {
            // Clear any existing interval
            if (ordersPollingInterval) {
                clearInterval(ordersPollingInterval);
            }
            
            // Check for new orders every 30 seconds
            ordersPollingInterval = setInterval(loadOrders, 30000);
        }

        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('drivers-tab-content').style.display = 'none';
            document.getElementById('orders-tab-content').style.display = 'none';
            
            // Show selected tab
            document.getElementById(tabName + '-tab-content').style.display = 'block';
            
            // Update active tab button
            document.querySelectorAll('#drivers-tab, #orders-tab').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            document.getElementById(tabName + '-tab').classList.remove('btn-secondary');
            document.getElementById(tabName + '-tab').classList.add('btn-primary');
            
            // Reset notification when viewing orders
            if (tabName === 'orders') {
                document.getElementById('order-notification').style.display = 'none';
                pendingOrdersCount = 0;
            }
        }

        async function loadRequests() {
            try {
                const res = await fetch(`${API_URL}/admin/drivers`);
                const drivers = await res.json();
                const container = document.getElementById('requests-list');
                container.innerHTML = '';

                // Separate pending and deletion requests
                const pending = drivers.filter(d => d.approvalStatus === 'PENDING');
                const deletionRequests = drivers.filter(d => d.deletionRequested === true);
                const others = drivers.filter(d => d.approvalStatus !== 'PENDING' && !d.deletionRequested);

                // Show Deletion Requests First
                if (deletionRequests.length > 0) {
                    const deleteSection = document.createElement('div');
                    deleteSection.innerHTML = '<h2 style="color: var(--error); margin: 2rem 0 1rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø°Ù âš ï¸</h2>';
                    container.appendChild(deleteSection);

                    deletionRequests.forEach(d => {
                        const card = createDriverCard(d, true);
                        container.appendChild(card);
                    });
                }

                // Show Pending Requests
                if (pending.length > 0) {
                    const pendingSection = document.createElement('div');
                    pendingSection.innerHTML = '<h2 style="color: orange; margin: 2rem 0 1rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ“‹</h2>';
                    container.appendChild(pendingSection);

                    pending.forEach(d => {
                        const card = createDriverCard(d, false);
                        container.appendChild(card);
                    });
                }

                // Show Others (Approved/Rejected)
                if (others.length > 0) {
                    const othersSection = document.createElement('div');
                    othersSection.innerHTML = '<h2 style="color: var(--text-sub); margin: 2rem 0 1rem;">Ø§Ù„Ø³Ø¬Ù„ ğŸ“</h2>';
                    container.appendChild(othersSection);

                    others.forEach(d => {
                        const card = createDriverCard(d, false);
                        container.appendChild(card);
                    });
                }

                if (drivers.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color: var(--text-sub);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                }
            } catch (error) {
                console.error('Error loading requests:', error);
                document.getElementById('requests-list').innerHTML = '<p style="text-align:center; color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>';
            }
        }

        function createDriverCard(d, isDeletion) {
            const isPending = d.approvalStatus === 'PENDING';
            const statusColor = d.approvalStatus === 'APPROVED' ? 'green' : d.approvalStatus === 'REJECTED' ? 'red' : 'orange';

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <h3>${d.name}</h3>
                    <span style="color:${statusColor}; font-weight:bold;">${d.approvalStatus || 'PENDING'}</span>
                </div>
                <div style="color:#aaa; font-size: 0.9rem; margin-top: 0.5rem;">
                    <p>ğŸ“± ${d.phone}</p>
                    <p>ğŸ’° ${d.price} Ø¯.Ù„</p>
                    ${d.priority ? `<p style="color: gold; font-weight: bold;">â­ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${d.priority}</p>` : ''}
                </div>
                
                ${isDeletion ? `
                <div style="margin-top:1rem; padding: 1rem; background: rgba(255,0,0,0.1); border-radius: 8px;">
                    <p style="color: var(--error); font-weight: bold;">âš ï¸ Ø·Ù„Ø¨ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</p>
                    <button onclick="permanentDelete('${d.id}')" class="btn" style="background:red; color:white; width:100%; margin-top: 0.5rem;">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ âŒ</button>
                </div>
                ` : ''}
                
                ${isPending && !isDeletion ? `
                <div style="display:flex; gap:10px; margin-top:1rem;">
                    <button onclick="decide('${d.id}', 'APPROVE', 10)" class="btn" style="background:gold; color:black; flex:1;">â­ Ù‚Ø¨ÙˆÙ„ (Ø£ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)</button>
                    <button onclick="decide('${d.id}', 'APPROVE', 0)" class="btn" style="background:green; color:white; flex:1;">âœ… Ù‚Ø¨Ù„ (Ø¹Ø§Ø¯ÙŠ)</button>
                    <button onclick="decide('${d.id}', 'REJECT', 0)" class="btn" style="background:red; color:white; flex:1;">âŒ Ø±ÙØ¶</button>
                </div>
                ` : ''}
                
                ${d.approvalStatus === 'APPROVED' && !isDeletion ? `
                <div style="display:flex; gap:10px; margin-top:1rem;">
                    <button onclick="setPriority('${d.id}', 10)" class="btn" style="background:gold; color:black; flex:1;">â­ Ø¶Ø¹ ÙÙŠ Ø§Ù„Ù…Ù‚Ø¯Ù…Ø©</button>
                    <button onclick="setPriority('${d.id}', 0)" class="btn" style="background:gray; color:white; flex:1;">â¬‡ï¸ Ø¹Ø§Ø¯ÙŠ</button>
                </div>
                ` : ''}
            `;
            return card;
        }

        async function loadOrders() {
            try {
                const res = await fetch(`${API_URL}/orders`);
                const orders = await res.json();
                const container = document.getElementById('orders-list');
                container.innerHTML = '';

                // Separate pending orders
                const pendingOrders = orders.filter(order => order.status === 'PENDING');
                const completedOrders = orders.filter(order => order.status !== 'PENDING');

                // Update notification badge
                pendingOrdersCount = pendingOrders.length;
                const notificationBadge = document.getElementById('order-notification');
                if (pendingOrdersCount > 0) {
                    notificationBadge.textContent = pendingOrdersCount;
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }

                // Show Pending Orders
                if (pendingOrders.length > 0) {
                    const pendingSection = document.createElement('div');
                    pendingSection.innerHTML = '<h2 style="color: orange; margin: 2rem 0 1rem;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ“‹</h2>';
                    container.appendChild(pendingSection);

                    pendingOrders.forEach(order => {
                        const card = createOrderCard(order);
                        container.appendChild(card);
                    });
                }

                // Show Completed Orders
                if (completedOrders.length > 0) {
                    const completedSection = document.createElement('div');
                    completedSection.innerHTML = '<h2 style="color: var(--text-sub); margin: 2rem 0 1rem;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ğŸ“</h2>';
                    container.appendChild(completedSection);

                    completedOrders.forEach(order => {
                        const card = createOrderCard(order);
                        container.appendChild(card);
                    });
                }

                if (orders.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color: var(--text-sub);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('orders-list').innerHTML = '<p style="text-align:center; color: red;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>';
            }
        }

        function createOrderCard(order) {
            const card = document.createElement('div');
            card.className = 'card';
            
            const statusColor = order.status === 'APPROVED' ? 'green' : order.status === 'REJECTED' ? 'red' : 'orange';
            const statusText = order.status === 'APPROVED' ? 'Ù…Ù‚Ø¨ÙˆÙ„' : order.status === 'REJECTED' ? 'Ù…Ø±ÙÙˆØ¶' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <h3>Ø·Ù„Ø¨ Ù…Ù†: ${order.customerName}</h3>
                    <span style="color:${statusColor}; font-weight:bold;">${statusText}</span>
                </div>
                <div style="color:#aaa; font-size: 0.9rem; margin-top: 0.5rem;">
                    <p>ğŸ“± ${order.customerPhone}</p>
                    <p>â° ${new Date(order.timestamp).toLocaleString('ar-LY')}</p>
                    ${order.notes ? `<p>ğŸ“ ${order.notes}</p>` : ''}
                    ${order.response ? `<p style="color: ${statusColor};">ğŸ’¬ ${order.response}</p>` : ''}
                </div>
                
                ${order.status === 'PENDING' ? `
                <div style="display:flex; gap:10px; margin-top:1rem;">
                    <button onclick="respondOrder('${order.id}', 'APPROVE')" class="btn" style="background:green; color:white; flex:1;">âœ… Ù…ÙˆØ§ÙÙ‚Ø©</button>
                    <button onclick="respondOrder('${order.id}', 'REJECT')" class="btn" style="background:red; color:white; flex:1;">âŒ Ø±ÙØ¶</button>
                </div>
                ` : ''}
            `;
            return card;
        }

        async function respondOrder(orderId, response) {
            const message = prompt(`Ø£Ø¯Ø®Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø±Ø¯:`);
            if (message === null) return; // User cancelled

            try {
                const res = await fetch(`${API_URL}/respond-order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderId, response, message })
                });
                const data = await res.json();

                if (data.success) {
                    alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨');
                    loadOrders();
                } else {
                    alert('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨: ' + data.message);
                }
            } catch (error) {
                console.error('Error responding to order:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            }
        }

        async function decide(id, action, priority) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

            try {
                await fetch(`${API_URL}/admin/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, action, priority })
                });
                loadRequests();
            } catch (error) {
                console.error('Error approving driver:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            }
        }

        async function permanentDelete(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) return;

            try {
                await fetch(`${API_URL}/admin/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                loadRequests();
            } catch (error) {
                console.error('Error deleting driver:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            }
        }

        async function setPriority(id, priority) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©ØŸ')) return;

            try {
                await fetch(`${API_URL}/admin/priority`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, priority })
                });
                loadRequests();
            } catch (error) {
                console.error('Error setting priority:', error);
                alert('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
            }
        }
    </script>
</body>

</html>
