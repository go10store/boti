<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ø¨ÙˆØ·ÙŠ</title>
    <link rel="stylesheet" href="style.css">
</head>

<body style="background: #0f172a;">
    <div class="container" style="max-width:800px; margin-top:3rem;">

        <!-- Login -->
        <div id="admin-login" class="card">
            <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2>
            <input type="password" id="adminPass" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"
                style="margin:1rem 0;">
            <button onclick="adminLogin()" class="btn btn-primary" style="width:100%">Ø¯Ø®ÙˆÙ„</button>
        </div>

        <!-- Dashboard -->
        <div id="admin-dash" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                <h1 style="color:var(--accent);">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…</h1>
                <button onclick="loadRequests()" class="btn btn-secondary">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>

            <div id="requests-list" class="grid" style="grid-template-columns: 1fr;">
                <!-- Items here -->
            </div>
        </div>

    </div>

    <script>
        const API_URL = '/api'; // Relative in production

        async function adminLogin() {
            const pwd = document.getElementById('adminPass').value;
            const res = await fetch(`${API_URL}/admin/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password: pwd })
            });
            const data = await res.json();

            if (data.success) {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-dash').style.display = 'block';
                loadRequests();
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©');
            }
        }

        async function loadRequests() {
            const res = await fetch(`${API_URL}/admin/drivers`);
            const drivers = await res.json();
            const container = document.getElementById('requests-list');
            container.innerHTML = '';

            // Separate pending and deletion requests
            const pending = drivers.filter(d => d.approvalStatus === 'PENDING');
            const deletionRequests = drivers.filter(d => d.deletionRequested === true);
            const others = drivers.filter(d => d.approvalStatus !== 'PENDING' && !d.deletionRequested);

            // Show Deletion Requests First
            if (deletionRequests.length > 0) {
                const deleteSection = document.createElement('div');
                deleteSection.innerHTML = '<h2 style="color: var(--error); margin: 2rem 0 1rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø°Ù âš ï¸</h2>';
                container.appendChild(deleteSection);

                deletionRequests.forEach(d => {
                    const card = createDriverCard(d, true);
                    container.appendChild(card);
                });
            }

            // Show Pending Requests
            if (pending.length > 0) {
                const pendingSection = document.createElement('div');
                pendingSection.innerHTML = '<h2 style="color: orange; margin: 2rem 0 1rem;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ“‹</h2>';
                container.appendChild(pendingSection);

                pending.forEach(d => {
                    const card = createDriverCard(d, false);
                    container.appendChild(card);
                });
            }

            // Show Others (Approved/Rejected)
            if (others.length > 0) {
                const othersSection = document.createElement('div');
                othersSection.innerHTML = '<h2 style="color: var(--text-sub); margin: 2rem 0 1rem;">Ø§Ù„Ø³Ø¬Ù„ ğŸ“</h2>';
                container.appendChild(othersSection);

                others.forEach(d => {
                    const card = createDriverCard(d, false);
                    container.appendChild(card);
                });
            }

            if (drivers.length === 0) {
                container.innerHTML = '<p style="text-align:center; color: var(--text-sub);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            }
        }

        function createDriverCard(d, isDeletion) {
            const isPending = d.approvalStatus === 'PENDING';
            const statusColor = d.approvalStatus === 'APPROVED' ? 'green' : d.approvalStatus === 'REJECTED' ? 'red' : 'orange';

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <h3>${d.name}</h3>
                    <span style="color:${statusColor}; font-weight:bold;">${d.approvalStatus || 'PENDING'}</span>
                </div>
                <div style="color:#aaa; font-size: 0.9rem; margin-top: 0.5rem;">
                    <p>ğŸ“± ${d.phone}</p>
                    <p>ğŸ“ ${d.location}</p>
                    <p>ğŸ’§ ${d.source}</p>
                    <p>ğŸ’° ${d.price} Ø¯.Ù„</p>
                    ${d.truckType ? `<p>ğŸš› ${d.truckType}</p>` : ''}
                    ${d.capacity ? `<p>ğŸ“¦ ${d.capacity} Ù„ØªØ±</p>` : ''}
                    ${d.workHours ? `<p>ğŸ• ${d.workHours}</p>` : ''}
                    ${d.bio ? `<p style="font-style: italic; margin-top: 0.5rem;">"${d.bio}"</p>` : ''}
                </div>
                
                ${isDeletion ? `
                <div style="margin-top:1rem; padding: 1rem; background: rgba(255,0,0,0.1); border-radius: 8px;">
                    <p style="color: var(--error); font-weight: bold;">âš ï¸ Ø·Ù„Ø¨ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</p>
                    <button onclick="permanentDelete('${d.id}')" class="btn" style="background:red; color:white; width:100%; margin-top: 0.5rem;">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ âŒ</button>
                </div>
                ` : ''}
                
                ${isPending && !isDeletion ? `
                <div style="display:flex; gap:10px; margin-top:1rem;">
                    <button onclick="decide('${d.id}', 'APPROVE', 10)" class="btn" style="background:gold; color:black; flex:1;">â­ Ù‚Ø¨ÙˆÙ„ (Ø£ÙˆÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©)</button>
                    <button onclick="decide('${d.id}', 'APPROVE', 0)" class="btn" style="background:green; color:white; flex:1;">âœ… Ù‚Ø¨ÙˆÙ„ (Ø¹Ø§Ø¯ÙŠ)</button>
                    <button onclick="decide('${d.id}', 'REJECT', 0)" class="btn" style="background:red; color:white; flex:1;">âŒ Ø±ÙØ¶</button>
                </div>
                ` : ''}
            `;
            return card;
        }

        async function decide(id, action, priority) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) return;

            await fetch(`${API_URL}/admin/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, action, priority })
            });
            loadRequests();
        }

        async function permanentDelete(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) return;

            await fetch(`${API_URL}/admin/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            loadRequests();
        }
    </script>
</body>

</html>
